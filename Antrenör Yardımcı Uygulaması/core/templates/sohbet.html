{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Sohbet - {{ karshi_taraf.first_name }}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        body { background-color: var(--ana-siyah); color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Üst Bar */
        .chat-header {
            background: #1e1e1e; padding: 15px 20px; border-bottom: 1px solid var(--altin-sarisi);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Mesaj Alanı */
        .chat-area {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;
            background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px; /* Hafif nokta deseni */
        }

        /* Baloncuklar */
        .message-bubble {
            max-width: 70%; padding: 12px 18px; border-radius: 15px; position: relative; font-size: 0.95rem; line-height: 1.4;
        }
        
        /* Gelen Mesaj (Sol) */
        .received {
            align-self: flex-start; background-color: #333; color: #fff; border-bottom-left-radius: 2px;
        }
        
        /* Giden Mesaj (Sağ) */
        .sent {
            align-self: flex-end; background-color: var(--altin-sarisi); color: #000; border-bottom-right-radius: 2px;
            font-weight: 500;
        }

        .time { font-size: 0.7rem; opacity: 0.7; margin-top: 5px; text-align: right; display: block; }

        /* Alt Bar (Yazma Alanı) */
        .input-area {
            background: #1e1e1e; padding: 15px; border-top: 1px solid #333;
            display: flex; gap: 10px;
        }
        .input-area input {
            flex: 1; padding: 15px; border-radius: 25px; border: 1px solid #444; background: #2a2a2a; color: white; outline: none;
        }
        .input-area input:focus { border-color: var(--altin-sarisi); }
        .send-btn {
            background: var(--altin-sarisi); border: none; width: 50px; height: 50px; border-radius: 50%;
            cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div class="chat-header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 40px; height: 40px; background: #444; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; color: var(--altin-sarisi);">
                {{ karshi_taraf.first_name|first }}
            </div>
            <div>
                <strong style="display: block;">{{ karshi_taraf.first_name }} {{ karshi_taraf.last_name }}</strong>
                <span style="font-size: 0.8rem; color: #aaa;">
                    {% if karshi_taraf.is_staff %}Antrenör{% else %}Öğrenci{% endif %}
                </span>
            </div>
        </div>
        
        {% if user.is_staff %}
            <a href="{% url 'mesaj_kutusu' %}" style="color: #fff; text-decoration: none;">✕ Kapat</a>
        {% else %}
            <a href="{% url 'ogrenci_paneli' %}" style="color: #fff; text-decoration: none;">✕ Kapat</a>
        {% endif %}
    </div>

    <div class="chat-area" id="chatContainer">
        {% for mesaj in mesajlar %}
            <div class="message-bubble {% if mesaj.gonderen == user %}sent{% else %}received{% endif %}">
                {{ mesaj.icerik }}
                <span class="time">{{ mesaj.tarih|date:"H:i" }} {% if mesaj.gonderen == user and mesaj.okundu_mu %}✓✓{% endif %}</span>
            </div>
        {% empty %}
            <p style="text-align: center; color: #666; margin-top: 20px;">Henüz mesaj yok. İlk mesajı sen gönder!</p>
        {% endfor %}
    </div>

    <form method="POST" class="input-area">
        {% csrf_token %}
        <input type="text" name="mesaj_icerigi" placeholder="Mesajınızı yazın..." required autocomplete="off">
        <button type="submit" class="send-btn">➤</button>
    </form>

    <script>
        // Sayfa açıldığında en alta kaydır
        var chatDiv = document.getElementById("chatContainer");
        chatDiv.scrollTop = chatDiv.scrollHeight;
    </script>

</body>
</html>